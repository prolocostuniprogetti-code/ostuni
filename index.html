<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ostuni Guida Turistica Interattiva</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden;}
        #sidebar { width: 300px; padding: 20px; background-color: #f8f8f8; overflow-y: auto; box-shadow: 2px 0 5px rgba(0,0,0,0.1);}
        #map { flex-grow: 1; height: 100%; }
        #tour-list { list-style: none; padding: 0; margin-top: 20px;}
        #tour-list li { background-color: #fff; margin-bottom: 8px; padding: 10px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s;}
        #tour-list li:hover, #tour-list li.selected { background-color: #bbdefb;}
        #dettaglio-monumento { margin-top: 20px; padding: 15px; border-top: 1px solid #ccc;}
        #dettaglio-monumento h3 { margin-top: 0; color: #1a73e8; }
        #dettaglio-monumento img { max-width: 100%; height: auto; border-radius: 4px; margin-bottom: 10px;}
        #overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 9999; display: flex; justify-content: center; align-items: center;}
        #overlay-box { background: white; padding: 28px 30px 18px 30px; border-radius: 10px; width: 100%; max-width: 340px; text-align:center;}
        @media (max-width: 800px) { #sidebar {width: 100vw; max-width: none;} body{flex-direction: column;}}
    </style>
</head>
<body>

<!-- Overlay di registrazione -->
<div id="overlay">
  <div id="overlay-box">
    <h2>Benvenuto/a!</h2>
    <p>Per iniziare inserisci il tuo nome:</p>
    <input id="username" type="text" placeholder="Nome..." style="width: 100%;margin-bottom:15px;padding:8px;">
    <button onclick="startApp()" style="padding: 8px 20px; background: #1a73e8; color: white; border-radius: 4px; border: none; font-size: 1em;">Entra</button>
  </div>
</div>

<div id="sidebar" style="filter: blur(2px);">
    <h2>Ostuni: Tour Interattivo</h2>
    <p>Seleziona un tour dalla lista:</p>
    <ul id="tour-list"></ul>
    <div id="dettaglio-monumento" style="display: none;">
        <h3>Dettaglio Monumento</h3>
        <h4 id="dettaglio-titolo"></h4>
        <p id="dettaglio-descrizione"></p>
        <img id="dettaglio-immagine" src="" alt="Immagine Monumento" style="display: none;">
        <audio id="dettaglio-audio" controls style="width:100%;display:none;"></audio>
    </div>
</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// Tour Monumentale - Coordinate aggiornate
const attrazioni = [
  {
    id: "monumentale",
    nome: "Ostuni Monumentale",
    elementi: [
      { titolo: "Obelisco di S. Oronzo", lat: 40.734073, lng: 17.579545, dettaglio: "" }, // Piazza della Libertà
      { titolo: "Chiesa dello Spirito Santo", lat: 40.731985, lng: 17.580276, dettaglio: "" }, // Piazza della Libertà
      { titolo: "Palazzo Municipale", lat: 40.734334, lng: 17.579508, dettaglio: "" }, // Piazza della Libertà/Palazzo di Città
      { titolo: "Chiesa San F. d'Assisi", lat: 40.734053, lng: 17.579635, dettaglio: "" }, // Piazza XX Settembre
      { titolo: "Cattedrale", lat: 40.730667, lng: 17.577983, dettaglio: "" }, // Via Cattedrale
      { titolo: "Chiesa Santa M. della Stella", lat: 40.734982, lng: 17.577405, dettaglio: "" }, // Via Clemente Leonardo
      { titolo: "Chiesa San Pietro", lat: 40.730654, lng: 17.578259, dettaglio: "" }, // Prossimità via Cattedrale, stimata
      { titolo: "Chiesa Madonna del Carmine", lat: 40.731088, lng: 17.578853, dettaglio: "" } // Via Madonna del Carmine
    ]
  },
  {
    id: "palazzi",
    nome: "Ostuni Segreta e Palazzi",
    elementi: [
      { titolo: "Palazzo Ayroldi", lat: 40.732463, lng: 17.580158, dettaglio: "" }, // Corso Vittorio Emanuele II
      { titolo: "Palazzo Siccodà", lat: 40.730837, lng: 17.577718, dettaglio: "" }, // Via Cattedrale
      { titolo: "Portale palazzo Bizantizzi", lat: 40.731695, lng: 17.579902, dettaglio: "" }, // Via Bizantini
      { titolo: "Portale palazzo Ghionda", lat: 40.731562, lng: 17.579605, dettaglio: "" }, // Via Ghionda
      { titolo: "Portale palazzo Falgheri", lat: 40.730934, lng: 17.577996, dettaglio: "" }, // Stimata centro storico
      { titolo: "Portale palazzo della Musica", lat: 40.732001, lng: 17.579197, dettaglio: "" }, // Stimata
      { titolo: "Portale palazzo Palmieri", lat: 40.730840, lng: 17.578002, dettaglio: "" }, // Via Cattedrale
      { titolo: "Portale palazzo Jurleo", lat: 40.731222, lng: 17.578315, dettaglio: "" }, // Stimata
      { titolo: "Portale palazzo Calamo", lat: 40.731944, lng: 17.579073, dettaglio: "" }, // Stimata
      { titolo: "Portale palazzo Mileti", lat: 40.731963, lng: 17.578840, dettaglio: "" } // Stimata
    ]
  },
  {
    id: "panorama",
    nome: "Ostuni Insolita e Panoramica",
    elementi: [
      { titolo: "Stemma degli Zevallos", lat: 40.731487, lng: 17.579691, dettaglio: "" }, // Stimata
      { titolo: "Capitello Corinzio", lat: 40.732126, lng: 17.579453, dettaglio: "" }, // Stimata
      { titolo: "Convento delle Monacelle", lat: 40.730701, lng: 17.578713, dettaglio: "" }, // Via Monacelle
      { titolo: "Chiesa Monacelle/Museo", lat: 40.730800, lng: 17.578213, dettaglio: "" }, // Stimata
      { titolo: "Volta di Federico II", lat: 40.731986, lng: 17.579084, dettaglio: "" }, // Stimata
      { titolo: "La Loggia, palazzo Vescovile", lat: 40.730796, lng: 17.577690, dettaglio: "" }, // Via Cattedrale
      { titolo: "Largo Pappadà", lat: 40.731203, lng: 17.578455, dettaglio: "" }, // Stimata
      { titolo: "Chiesa San G. in Compostela", lat: 40.734828, lng: 17.575421, dettaglio: "" }, // Stimata
      { titolo: "Porta San Demetrio", lat: 40.733227, lng: 17.578994, dettaglio: "" }, // Porta S. Demetrio
      { titolo: "Porta Nova", lat: 40.730122, lng: 17.577477, dettaglio: "" } // Porta Nova
    ]
  }
];

var map, markers = L.layerGroup(), currentPolyline = null;

function startApp() {
    const nome = document.getElementById('username').value.trim();
    if (!nome) { alert("Inserisci il nome"); return; }
    document.getElementById('overlay').style.display = 'none';
    document.getElementById('sidebar').style.filter = 'none';
}

function initMap() {
    map = L.map('map', {
        center: [40.731224, 17.579126], zoom: 16, scrollWheelZoom: true, dragging: true
    });
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);
    markers.addTo(map);
}

function caricaTour(tourId) {
    markers.clearLayers();
    if (currentPolyline) { map.removeLayer(currentPolyline); currentPolyline = null; }
    const tour = attrazioni.find(t => t.id === tourId);
    if (tour) {
        let tourCoordinates = [];
        tour.elementi.forEach(el => {
            tourCoordinates.push([el.lat, el.lng]);
            const marker = L.marker([el.lat, el.lng])
              .bindPopup(`<b>${el.titolo}</b>`)
              .on('click', () => mostraDettaglio(el));
            markers.addLayer(marker);
        });
        if (tourCoordinates.length > 1) {
            currentPolyline = L.polyline(tourCoordinates, { color: 'blue', weight: 4, opacity: 0.6 }).addTo(map);
        }
        let bounds = L.latLngBounds(tourCoordinates);
