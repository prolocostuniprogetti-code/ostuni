<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ostuni Guida Turistica Interattiva</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIINfBIHPZgW1ZefU4MoSA6gDLp3zEhec2Y=" 
          crossorigin=""/>
    
    <style>
        body { font-family: Arial, sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden;}
        #sidebar { width: 300px; padding: 20px; background-color: #f8f8f8; overflow-y: auto; box-shadow: 2px 0 5px rgba(0,0,0,0.1);}
        #map { flex-grow: 1; height: 100%; }
        #tour-list { list-style: none; padding: 0; margin-top: 20px;}
        #tour-list li { background-color: #fff; margin-bottom: 8px; padding: 10px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s;}
        #tour-list li:hover, #tour-list li.selected { background-color: #bbdefb;}
        #dettaglio-monumento { margin-top: 20px; padding: 15px; border-top: 1px solid #ccc;}
        #dettaglio-monumento h3 { margin-top: 0; color: #1a73e8; }
        #dettaglio-monumento img { max-width: 100%; height: auto; border-radius: 4px; margin-bottom: 10px;}
        /* Stili Overlay */
        #overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 9999; display: flex; justify-content: center; align-items: center;}
        #overlay-box { background: white; padding: 28px 30px 18px 30px; border-radius: 10px; width: 100%; max-width: 340px; text-align:center;}
        /* Media Query Mobile */
        @media (max-width: 800px) { #sidebar {width: 100vw; max-width: none;} body{flex-direction: column;}}
    </style>
</head>
<body>

<div id="overlay">
  <div id="overlay-box">
    <h2>Benvenuto/a!</h2>
    <p>Per iniziare inserisci il tuo nome:</p>
    <input id="username" type="text" placeholder="Nome..." style="width: 100%;margin-bottom:15px;padding:8px;">
    <button onclick="startApp()" style="padding: 8px 20px; background: #1a73e8; color: white; border-radius: 4px; border: none; font-size: 1em;">Entra</button>
  </div>
</div>

<div id="sidebar" style="filter: blur(2px);">
    <h2>Ostuni: Tour Interattivo</h2>
    <p>Seleziona un tour dalla lista:</p>
    <ul id="tour-list"></ul>
    <div id="dettaglio-monumento" style="display: none;">
        <h3>Dettaglio Monumento</h3>
        <h4 id="dettaglio-titolo"></h4>
        <p id="dettaglio-descrizione"></p>
        <img id="dettaglio-immagine" src="" alt="Immagine Monumento" style="display: none;">
        <audio id="dettaglio-audio" controls style="width:100%;display:none;"></audio>
    </div>
</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
        integrity="sha256-20n6cT99BfiY7zIFL8/5sa0W4IzASG4FcdWab2kT66F8=" 
        crossorigin=""></script> 
    
<script src="./dettagli/data.js"></script> 

<script>
// Variabili Globali
var map, markers = L.layerGroup(), currentPolyline = null;

// Funzioni per Overlay e Dettagli (Il tuo codice)
function startApp() {
    const nome = document.getElementById('username').value.trim();
    if (!nome) { alert("Inserisci il nome"); return; }
    document.getElementById('overlay').style.display = 'none';
    document.getElementById('sidebar').style.filter = 'none';
}

function mostraDettaglio(elemento) {
    document.getElementById('dettaglio-monumento').style.display = 'block';
    document.getElementById('dettaglio-titolo').textContent = elemento.titolo;
    document.getElementById('dettaglio-descrizione').textContent = elemento.dettaglio;
    document.getElementById('dettaglio-immagine').src = elemento.immagine || ''; // Usa .immagine, non .img
    document.getElementById('dettaglio-immagine').style.display = elemento.immagine ? 'block' : 'none';
    document.getElementById('dettaglio-audio').src = elemento.audio || '';
    document.getElementById('dettaglio-audio').style.display = elemento.audio ? 'block' : 'none';
}


// Funzione 1: Inizializza la Mappa (con Proiezione Corretta)
function initMap() {
    map = L.map('map', {
        center: [40.7305, 17.5775], 
        zoom: 15, 
        scrollWheelZoom: true, 
        dragging: true,
        // CORREZIONE CRITICA: Forza la corretta proiezione GPS
        crs: L.CRS.EPSG4326 
    });
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);
    markers.addTo(map);
}

// Funzione 2: Carica i marcatori per un tour specifico (Tuo Codice)
function caricaTour(tourId) {
    markers.clearLayers();
    if (currentPolyline) { map.removeLayer(currentPolyline); currentPolyline = null; }
    const tour = attrazioni.find(t => t.id === tourId);
    if (tour) {
        let tourCoordinates = [];
        tour.elementi.forEach(el => {
            tourCoordinates.push([el.lat, el.lng]);
            const marker = L.marker([el.lat, el.lng])
              .bindPopup(`<b>${el.titolo}</b>`)
              .on('click', () => mostraDettaglio(el));
            markers.addLayer(marker);
        });
        if (tourCoordinates.length > 1) {
            currentPolyline = L.polyline(tourCoordinates, { color: 'blue', weight: 4, opacity: 0.6 }).addTo(map);
        }
        let bounds = L.latLngBounds(tourCoordinates);
        map.fitBounds(bounds, {padding: [50,50]});
    }
    Array.from(document.getElementById('tour-list').children).forEach(li => li.classList.remove('selected'));
    const idx = attrazioni.findIndex(t => t.id === tourId);
    if (idx !== -1) document.getElementById('tour-list').children[idx].classList.add('selected');
    document.getElementById('dettaglio-monumento').style.display = 'none';
}

// Funzione 3: Inizializza l'intera applicazione
function initApp() {
    initMap();
    
    // CORREZIONE CRITICA FINALE: Forziamo il ridisegno dopo un breve ritardo
    // Questo risolve i bug di disallineamento e mappa sparita persistenti.
    setTimeout(() => {
        map.invalidateSize(); 
        console.log("Mappa ridisegnata forzatamente.");
    }, 100); 

    const tourList = document.getElementById('tour-list');
    tourList.innerHTML = '';
    attrazioni.forEach((tour) => {
        const li = document.createElement('li');
        li.textContent = tour.nome;
        li.onclick = () => caricaTour(tour.id);
        tourList.appendChild(li);
    });
}

document.addEventListener('DOMContentLoaded', initApp);
</script>
</body>
</html>
